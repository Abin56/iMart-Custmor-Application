#!/usr/bin/env bash
# ============================================
# imart pre-commit hook (Windows + Flutter)
# ============================================

RED="\033[0;31m"; GREEN="\033[0;32m"; YELLOW="\033[1;33m"; BLUE="\033[0;34m"; NC="\033[0m"
ok(){ echo -e "${GREEN}✔ $1${NC}"; }
err(){ echo -e "${RED}✖ $1${NC}"; }
warn(){ echo -e "${YELLOW}! $1${NC}"; }
header(){ echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n${BLUE}$1${NC}\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"; }

header "Running imart Pre-commit Checks"

# Fetch staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED_FILES" ]; then
  warn "No files staged for commit."
  exit 0
fi

# =======================================================
# 1) Ensuring UTF-8 Encoding & Formatting Dart files
# =======================================================
header "1) Formatting Dart files"

DART_FILES=$(echo "$STAGED_FILES" | grep '\.dart$' || true)
if [ -n "$DART_FILES" ]; then
  echo "Ensuring UTF-8 encoding & formatting Dart files..."

  # Format each file safely
  FORMAT_FAIL=false
  for f in $DART_FILES; do
    if [ -f "$f" ]; then
      echo " → Checking $f"
      dart format "$f" >/dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo "   ⚠ Failed to format: $f"
        FORMAT_FAIL=true
      else
        git add "$f"
      fi
    fi
  done

  if [ "$FORMAT_FAIL" = true ]; then
    err "dart format failed on one or more files (check encoding or syntax)"
    exit 1
  fi

  ok "Formatted & re-staged all Dart files"
else
  warn "No Dart files found to format"
fi

# 2️⃣ Flutter analyze
header "2) Flutter analyze"
flutter analyze >/dev/null 2>&1
if [ $? -ne 0 ]; then err "Analyzer found issues. Run 'flutter analyze'."; exit 1; fi
ok "Analyzer passed"

# 3️⃣ custom_lint
header "3) Running custom_lint"
dart run custom_lint >/dev/null 2>&1
if [ $? -ne 0 ]; then err "custom_lint found issues"; exit 1; fi
ok "custom_lint passed"

# 4️⃣ Debug prints check
header "4) Checking for debug prints / TODOs"
DEBUG_FOUND=false
for f in $DART_FILES; do
  if grep -E "print\(|debugPrint\(" "$f" | grep -v "^[[:space:]]*//" >/dev/null 2>&1; then
    echo " ⚠ $f"
    DEBUG_FOUND=true
  fi
done
if [ "$DEBUG_FOUND" = true ]; then err "Remove print()/debugPrint() before committing"; exit 1; fi
ok "No debug prints"

# 5️⃣ Folder Structure Validation
header "5) Validating folder structure"

ALLOWED_PATHS=(
  "^lib/app/"
  "^lib/app/bootstrap/"
  "^lib/app/config/"
  "^lib/app/router/"
  "^lib/app/router/guards/"
  "^lib/app/theme/"
  "^lib/app/localization/"
  "^lib/app/localization/arb/"
  "^lib/app/monitoring/"
  "^lib/core/"
  "^lib/core/network/"
  "^lib/core/storage/"
  "^lib/core/storage/hive/"
  "^lib/core/storage/hive/adapters/"
  "^lib/core/utils/"
  "^lib/core/widgets/"
  "^lib/core/error/"
  "^lib/features/"
  "^lib/features/[a-z0-9_]+/domain/"
  "^lib/features/[a-z0-9_]+/application/"
  "^lib/features/[a-z0-9_]+/infrastructure/"
  "^lib/features/[a-z0-9_]+/presentation/"
  "^lib/features/common/"
  "^lib/main.dart$"
  "^lib/globals.dart$"
)
INVALID_FILES=()
for file in $STAGED_FILES; do
  if [[ "$file" == lib/* ]]; then
    VALID=false
    for pattern in "${ALLOWED_PATHS[@]}"; do
      if [[ "$file" =~ $pattern ]]; then VALID=true; break; fi
    done
    if [ "$VALID" = false ]; then INVALID_FILES+=("$file"); fi
  fi
done
if [ ${#INVALID_FILES[@]} -gt 0 ]; then
  err "Folder structure violation:"
  for f in "${INVALID_FILES[@]}"; do echo "  ⚠ $f"; done
  exit 1
fi
ok "Folder structure valid"

# 6️⃣ Dart file naming validation
header "6) Validating Dart file names"

declare -A ALLOWED_DART_FILES
ALLOWED_DART_FILES["lib/app/bootstrap/"]="app_bootstrap.dart hive_init.dart env_loader.dart"
ALLOWED_DART_FILES["lib/app/config/"]="env.dart constants.dart feature_flags.dart"
ALLOWED_DART_FILES["lib/app/router/"]="app_router.dart"
ALLOWED_DART_FILES["lib/app/theme/"]="colors.dart typography.dart theme.dart"
ALLOWED_DART_FILES["lib/app/localization/"]="l10n.dart"
ALLOWED_DART_FILES["lib/core/network/"]="api_client.dart endpoints.dart network_exceptions.dart"
ALLOWED_DART_FILES["lib/core/storage/hive/"]="boxes.dart keys.dart"
ALLOWED_DART_FILES["lib/core/utils/"]="date_utils.dart validators.dart logger.dart"
ALLOWED_DART_FILES["lib/core/error/"]="failure.dart error_view.dart"

INVALID_DART_FILES=()
for file in $DART_FILES; do
  for folder in "${!ALLOWED_DART_FILES[@]}"; do
    if [[ "$file" == "$folder"* ]]; then
      filename=$(basename "$file")
      allowed_list="${ALLOWED_DART_FILES[$folder]}"
      if ! echo "$allowed_list" | grep -qw "$filename"; then
        INVALID_DART_FILES+=("$file")
      fi
    fi
  done
done
if [ ${#INVALID_DART_FILES[@]} -gt 0 ]; then
  err "Invalid Dart files for their folders:"
  for f in "${INVALID_DART_FILES[@]}"; do echo "  ⚠ $f"; done
  exit 1
fi
ok "Dart file names validated successfully"

# 7️⃣ Riverpod State Mutation Violation Check
header "7) Checking for illegal .state mutations"

VIOLATION_FOUND=false

for f in $DART_FILES; do
  if grep -E "\.state\s*=" "$f" >/dev/null 2>&1; then

    # allow if the file contains a StateNotifier class definition
    if ! grep -E "class\s+[A-Za-z0-9_]+\s+extends\s+StateNotifier" "$f" >/dev/null 2>&1; then
      echo " ⚠ Illegal state mutation in: $f"
      VIOLATION_FOUND=true
    fi
  fi
done

if [ "$VIOLATION_FOUND" = true ]; then
  err "Direct .state mutations outside StateNotifier are NOT allowed."
  exit 1
fi

ok "No direct .state mutations found"

header "✅ All Checks Passed"
ok "Proceeding with commit..."
exit 0